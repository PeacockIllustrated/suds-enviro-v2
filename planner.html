<!DOCTYPE html>
<html>
<head>
<title>SuDS Enviro - Drainage System Builder</title> 
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css"> <!-- Added shared CSS -->
<style>
/* ... (original styles from planner.html) ... */
:root{--suds-blue:#1d80b9;--suds-green:#54b54d;--suds-red:#c34c4a;--suds-text-dark:#333;--suds-text-heading:var(--suds-blue);--suds-text-label:var(--suds-text-dark);--suds-border-light:#d1d5db;--suds-bg-light:#f9fafb;--suds-medium-grey:#e9ecef;--primary-blue:var(--suds-blue);--primary-blue-dark:#16699b;--primary-green:var(--suds-green);--primary-green-dark:#4e9a44;--light-grey:var(--suds-bg-light);--medium-grey:var(--suds-medium-grey);--dark-grey:#6c757d;--text-color:var(--suds-text-dark);--border-color:var(--suds-border-light);--locked-red:var(--suds-red);--locked-red-dark:#c82333;--drag-highlight-color:var(--primary-green);--ruler-color:#e6007e;--tooltip-bg:rgba(0,0,0,0.8);--tooltip-text:#ffffff;--shadow-sm:0 1px 2px 0 rgba(0,0,0,0.05);--shadow-md:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06);--shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);}
html,body{height:100%;margin:0;overflow:hidden;}
body{font-family:'Montserrat',sans-serif;display:flex;background-color:var(--light-grey);color:var(--text-color);font-weight:400;font-size:15px;line-height:1.6; padding-top: 60px; /* Ensure content below navbar */}
#planner-container{display:flex;flex-direction:row;width:100%;height:calc(100% - 60px);min-height:550px;border:1px solid var(--border-color);box-shadow:var(--shadow-md);background-color:#fff;overflow:hidden;font-family:'Montserrat',sans-serif;position:relative;}
#toolbar{width:30%;max-width:280px;padding:20px 15px;border-right:1px solid var(--border-color);background-color:var(--light-grey);display:flex;flex-direction:column;align-items:stretch;flex-shrink:0;overflow-y:auto;transition:background-color 0.3s ease;}
#toolbar h3,#item-list-panel h3,.control-group h3{margin:0 0 10px 0;font-size:1.1em;font-weight:700;color:var(--suds-blue);text-align:left;width:100%;text-transform:uppercase;letter-spacing:0.5px;padding-bottom:8px;border-bottom:2px solid var(--suds-blue);}
#component-items{display:flex;flex-direction:column;align-items:stretch;width:100%;margin-bottom:15px;gap:6px;min-height:50px;flex-shrink:0;}
.component-selector{display:flex;align-items:center;width:100%;padding:8px 10px;border-radius:8px;transition:background-color 0.2s ease,border-color 0.2s ease;border:1px solid transparent;cursor:pointer;}
.component-selector:hover{background-color:var(--medium-grey);border-color:#ccc;}
.component-selector.selected{background-color:var(--suds-blue);border-color:var(--primary-blue-dark);}
.component-selector.selected .toolbar-item{background-color:white;color:var(--suds-blue);border-color:var(--suds-blue);}
.component-selector.selected .component-label{color:white;font-weight:600;}
.toolbar-item{width:38px;height:38px;border:2px solid var(--suds-blue);border-radius:50%;display:flex;justify-content:center;align-items:center;flex-shrink:0;font-size:0.9em;font-weight:700;color:var(--suds-blue);background-color:#fff;cursor:pointer;transition:all 0.2s ease;box-shadow:var(--shadow-sm);text-align:center;line-height:1.1;}
.toolbar-item:hover{transform:scale(1.05);box-shadow:var(--shadow-md);}
.component-label{margin-left:12px;font-size:0.85em;color:var(--text-color);flex-grow:1;font-weight:500;word-break:break-word;line-height:1.3;display:inline-block;vertical-align:middle;}
#controls{margin-top:15px;width:100%;padding-top:15px;border-top:1px solid var(--border-color);flex-shrink:0;}
.control-group{margin-bottom:20px;}
.control-button,.mode-button{display:block;width:100%;padding:10px 5px;margin-bottom:6px;font-size:0.9em;text-align:center;border:1px solid var(--suds-blue);border-radius:20px;background-color:var(--suds-blue);color:white;cursor:pointer;transition:all 0.2s ease;box-sizing:border-box;font-family:'Montserrat',sans-serif;font-weight:600;box-shadow:var(--shadow-sm);}
.control-button:hover,.mode-button:hover{background-color:var(--primary-blue-dark);border-color:var(--primary-blue-dark);box-shadow:var(--shadow-md);transform:translateY(-1px);}
.mode-button.active{background-color:var(--suds-green);border-color:var(--primary-green-dark);}
#lock-bg{background-color:var(--suds-green);border-color:var(--primary-green-dark);}
#lock-bg.active{background-color:var(--suds-red);border-color:var(--locked-red-dark);}
#lock-bg:hover:not(.active){background-color:var(--primary-green-dark);border-color:var(--primary-green-dark);}
#lock-bg.active:hover{background-color:var(--locked-red-dark);border-color:var(--locked-red-dark);}
#image-upload{display:none;}
#upload-label{background-color:var(--dark-grey);border-color:#5a6268;}
#upload-label:hover{background-color:#5a6268;border-color:#545b62;}
#view-controls{display:flex;justify-content:space-between;flex-wrap:wrap;margin-bottom:6px;}
#view-controls .control-button{width:49%;margin-bottom:6px;}
#opacity-control{width:100%;margin-bottom:15px;}
#opacity-control label{display:block;font-size:0.8em;text-align:center;margin-bottom:5px;color:var(--text-color);font-weight:500;}
#bg-opacity{display:block;width:95%;margin:0 auto;cursor:pointer;accent-color:var(--primary-blue);}
#scale-display{font-size:0.8em;color:var(--dark-grey);text-align:center;margin-top:8px;padding:4px;min-height:1.2em;background-color:var(--medium-grey);border-radius:4px;border:1px solid var(--border-color);}
#canvas-container{flex-grow:1;position:relative;overflow:hidden;background-color:#ffffff;cursor:grab;border-left:1px solid var(--border-color);border-right:1px solid var(--border-color);}
#canvas-container.panning{cursor:grabbing;} #canvas-container.crosshair-cursor{cursor:crosshair;} #canvas-container.pointer-cursor{cursor:pointer;} #canvas-container.copy-cursor{cursor:copy;} #canvas-container.move-cursor{cursor:move;} #canvas-container.locked-cursor{cursor:not-allowed;}
#planner-canvas{display:block;background-color:#ffffff;}
#properties-panel{position:absolute;top:15px;right:15px;background-color:#ffffff;border-left:4px solid var(--suds-blue);border-radius:6px;padding:15px;box-shadow:var(--shadow-md);display:none;z-index:10;width:240px;border-top:1px solid var(--border-color);border-right:1px solid var(--border-color);border-bottom:1px solid var(--border-color);}
#properties-panel label{display:block;margin-bottom:8px;font-size:0.9em;font-weight:600;color:var(--suds-text-label-green);}
#properties-panel input{width:100%;padding:10px 12px;border:1px solid var(--border-color);border-radius:15px;box-sizing:border-box;font-family:'Montserrat',sans-serif;font-size:0.9em;transition:border-color 0.2s ease,box-shadow 0.2s ease;}
#properties-panel input:focus{border-color:var(--suds-blue);box-shadow:0 0 0 3px rgba(29,128,185,0.2);outline:none;}
#item-list-panel{width:25%;max-width:220px;padding:20px 15px;background-color:var(--light-grey);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;}
#placed-items-list{width:100%;list-style:none;padding:0;margin:0;flex-grow:1;min-height:30px;}
.placed-item-entry{display:flex;align-items:flex-start;background-color:#fff;border:1px solid var(--border-color);border-radius:8px;padding:10px 12px;margin-bottom:10px;cursor:pointer;transition:all 0.2s ease;box-shadow:var(--shadow-sm);}
.placed-item-entry:hover{border-color:#aaa;box-shadow:var(--shadow-md);}
.item-list-icon{width:22px;height:22px;border-radius:50%;background-color:var(--suds-blue);color:white;display:inline-flex;justify-content:center;align-items:center;font-size:0.75em;font-weight:bold;margin-right:10px;flex-shrink:0;margin-top:1px;box-shadow:inset 0 1px 1px rgba(0,0,0,0.1);}
.item-list-details{font-size:0.9em;color:var(--text-color);flex-grow:1;white-space:normal;word-break:break-word;}
.item-list-name{display:block;font-weight:700;margin-bottom:3px;color:var(--text-color);font-size:0.9em;}
.item-list-label{display:block;font-size:0.85em;color:var(--dark-grey);margin-bottom:5px;font-style:italic;}
.item-list-connections{font-size:0.8em;color:var(--dark-grey);margin-top:6px;padding-top:6px;border-top:1px dashed var(--border-color);}
.item-list-connections div{margin-bottom:3px;}
.placed-item-entry.dragging{opacity:0.4;cursor:grabbing;box-shadow:var(--shadow-lg);}
.placed-item-entry.drag-over{border-top:3px solid var(--drag-highlight-color);background-color:#e0ffe0;}
#canvas-tooltip{position:absolute;display:none;background-color:var(--tooltip-bg);color:var(--tooltip-text);border-radius:5px;padding:6px 10px;font-size:0.85em;white-space:nowrap;z-index:20;pointer-events:none;box-shadow:2px 2px 5px rgba(0,0,0,0.3);transition:opacity 0.1s ease;}
@media (max-width:768px){body{font-size:14px;padding-top:110px; /* Adjust for taller mobile navbar */}#planner-container{flex-direction:column;height:calc(100vh - 110px);min-height:0;}#toolbar,#item-list-panel{width:100%;max-width:none;height:auto;max-height:35%;border-right:none;border-left:none;border-bottom:1px solid var(--border-color);padding:10px;flex-shrink:1;}#toolbar h3,#item-list-panel h3,.control-group h3{font-size:1em;margin-bottom:8px;}#component-items{margin-bottom:10px;}.component-selector{margin-bottom:5px;padding:5px;}.toolbar-item{width:35px;height:35px;font-size:0.8em;}.component-label{font-size:0.8em;margin-left:8px;}#controls{padding-top:5px;border-top:1px solid var(--border-color);}.control-group{margin-bottom:10px;}.control-button,.mode-button{padding:8px 5px;font-size:0.8em;margin-bottom:4px;border-radius:15px;}#view-controls .control-button{width:49%;margin-bottom:4px;}#opacity-control label{font-size:0.75em;}#scale-display{font-size:0.7em;margin-top:4px;}#canvas-container{flex-grow:1;border-left:none;border-right:none;min-height:250px;}#properties-panel{width:180px;padding:10px;top:10px;right:10px;font-size:0.9em;}#item-list-panel{order:3;max-height:30%;}.placed-item-entry{padding:6px 8px;margin-bottom:6px;}.item-list-icon{width:18px;height:18px;font-size:0.7em;margin-right:6px;}.item-list-details{font-size:0.8em;}.item-list-name{font-size:0.85em;}.item-list-label{font-size:0.8em;margin-bottom:3px;}.item-list-connections{font-size:0.75em;margin-top:4px;padding-top:4px;}}
</style>
</head>
<body>
<nav class="navbar">
    <div class="nav-logo">
        <img src="https://uploads-ssl.webflow.com/6662e401ea62d861a416088f/6662e78d9725ab79209f1b60_Primary%20Logo%20-%20Colour.svg" alt="SuDS Enviro Logo">
    </div>
    <ul class="nav-links">
        <li><a href="index.html">Tools Hub</a></li>
        <li><a href="planner.html" class="active">Drainage Planner</a></li>
        <li><a href="all_configs.html">Saved Configurations</a></li>
    </ul>
</nav>

<div id="planner-container">
    <!-- ... (original content of planner-container) ... -->
    <div id="toolbar">
        <h3>COMPONENTS</h3>
        <div id="component-items">
             <p style="text-align:center;font-size:0.8em;color:#6c757d;margin-top:10px;">Loading saved components...</p>
        </div>
        <div id="controls">
             <div class="control-group"> <h3>MODE</h3> <button class="mode-button" id="mode-place" title="Place selected component">Place</button> <button class="mode-button" id="mode-move" title="Move components / unlocked background (Hold Shift to snap)">Move</button> <button class="mode-button" id="mode-connect" title="Connect two components">Connect</button> <button class="mode-button" id="mode-scale" title="Set scale using ruler">Scale</button> <button class="mode-button" id="mode-delete" title="Delete components/connections">Delete</button> </div>
             <div class="control-group"> <h3>VIEW</h3> <div id="view-controls"> <button class="control-button" id="zoom-reset" title="Reset Zoom and Pan">Reset View</button> <button class="control-button" id="lock-bg" title="Unlock background movement">Unlock BG</button> </div> <button class="control-button" id="toggle-overlay" title="Show/Hide background image">Toggle BG</button> <div id="opacity-control"> <label for="bg-opacity">BG Opacity</label> <input type="range" id="bg-opacity" min="0" max="1" step="0.05" value="1" title="Adjust background image opacity"> </div> <div id="scale-display">Scale not set</div> </div>
             <div class="control-group"> <h3>FILE</h3> <input type="file" id="image-upload" accept="image/*"> <label for="image-upload" id="upload-label" class="control-button" title="Upload site plan image">Upload BG</label> <button class="control-button" id="save-plan" title="Save plan to browser">Save</button> <button class="control-button" id="load-plan" title="Load plan from browser">Load</button> <button class="control-button" id="export-png" title="Export view as PNG">Export PNG</button> <button class="control-button" id="export-list" title="Export connections list as CSV">Export Connections</button> <button class="control-button" id="clear-all" title="Clear the entire plan">Clear All</button> </div>
        </div>
    </div>
    <div id="canvas-container">
        <canvas id="planner-canvas"> Your browser does not support the HTML canvas tag. </canvas>
        <div id="properties-panel"> <label for="item-label">Label:</label> <input type="text" id="item-label" placeholder="Enter item label"> </div>
        <div id="canvas-tooltip"></div>
    </div>
    <div id="item-list-panel">
        <h3>PLACED ITEMS</h3>
        <div id="placed-items-list"> <p style="text-align:center;font-size:0.8em;color:#6c757d;margin-top:10px;">No items placed yet.</p> </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded',function(){
// ***** MODIFICATION: Define plannerDataStorageKey *****
const plannerDataStorageKey = 'sudsPlannerState'; 
// ***** END MODIFICATION *****

const itemListContainer=document.getElementById('placed-items-list'),canvas=document.getElementById('planner-canvas'),ctx=canvas.getContext('2d'),canvasContainer=document.getElementById('canvas-container'),componentItemsContainer=document.getElementById('component-items'),placeModeButton=document.getElementById('mode-place'),moveModeButton=document.getElementById('mode-move'),connectModeButton=document.getElementById('mode-connect'),scaleModeButton=document.getElementById('mode-scale'),deleteModeButton=document.getElementById('mode-delete'),clearButton=document.getElementById('clear-all'),imageUploadInput=document.getElementById('image-upload'),toggleOverlayButton=document.getElementById('toggle-overlay'),zoomResetButton=document.getElementById('zoom-reset'),lockBgButton=document.getElementById('lock-bg'),saveButton=document.getElementById('save-plan'),loadButton=document.getElementById('load-plan'),exportPngButton=document.getElementById('export-png'),exportListButton=document.getElementById('export-list'),propertiesPanel=document.getElementById('properties-panel'),itemLabelInput=document.getElementById('item-label'),bgOpacitySlider=document.getElementById('bg-opacity'),scaleDisplayElement=document.getElementById('scale-display'),canvasTooltip=document.getElementById('canvas-tooltip');
const gridSpacing=20,gridColor='rgba(207, 226, 243, 0.6)',itemRadius=15,connectionColor='#0056b3',connectionWidth=2.5,selectionHighlightColor='#ffc107',scrollZoomFactor=1.005,minScale=0.2,maxScale=5.0,rulerColor=getComputedStyle(document.documentElement).getPropertyValue('--ruler-color').trim()||'#ff00ff',hoverThreshold=6,isTouchDevice=('ontouchstart'in window)||(navigator.maxTouchPoints>0);
let placedItems=[],connections=[],currentMode='place',selectedSavedConfig=null,selectedToolbarElement=null,isConnecting=!1,connectionStartItemId=null,nextItemId=0,backgroundImage=null,isOverlayVisible=!1,scale=1.0,originX=0,originY=0,isDraggingItem=!1,isPanning=!1,isDraggingBackground=!1,draggedItemId=null,selectedItemId=null,lastMouseX=0,lastMouseY=0,bgOpacity=1.0,bgImageX=0,bgImageY=0,isBackgroundLocked=!0,draggedListElement=null,worldScale=null,worldUnits='',isDrawingRuler=!1,rulerStartPoint=null,rulerEndPoint=null,hoveredItemId=null,hoveredConnection=null,dragStartX=0,dragStartY=0;
// const savedConfigStorageKey='sudsSavedConfigs'; // This remains for loading components

function getInitials(name){if(!name)return'?';if(name==='SEHDS')return'HS';if(name.startsWith('OFC-'))return'FC';if(name==='SIC'||name==='FIC'||name==='SERSIC'||name==='SERFIC')return'IC';const words=name.split(/[\s-/]+/);if(words.length>1&&words[0].length>0&&words[1].length>0){return(words[0][0]+words[1][0]).toUpperCase();}else if(words.length===1&&words[0].length>1){return words[0].substring(0,2).toUpperCase();}else if(words.length===1&&words[0].length===1){return words[0].toUpperCase();}else{return name.substring(0,2).toUpperCase()||'?';}}
function loadSavedComponents(){componentItemsContainer.innerHTML='';let savedConfigs=[];const savedConfigStorageKey='sudsSavedConfigs';try{const storedData=localStorage.getItem(savedConfigStorageKey);if(storedData){savedConfigs=JSON.parse(storedData);if(!Array.isArray(savedConfigs)){console.warn("localStorage data for",savedConfigStorageKey,"is not an array. Resetting.",savedConfigs);savedConfigs=[];}}}catch(e){console.error("Error parsing saved configurations from localStorage:",e);savedConfigs=[];} if(savedConfigs.length===0){componentItemsContainer.innerHTML='<p style="text-align:center;font-size:0.8em;color:#6c757d;margin-top:10px;">No saved configurations found.</p>';return;} savedConfigs.forEach((config,index)=>{try{const configId=config.savedId||`saved-${index}-${Date.now()}`;const productCode=config.generated_product_code||'Unknown Code';const productName=config.derived_product_name||'Unknown Product';const initials=getInitials(productName);const selectorDiv=document.createElement('div');selectorDiv.className='component-selector suds-component-item';selectorDiv.dataset.configId=configId;try{selectorDiv.dataset.configData=JSON.stringify(config);}catch(stringifyError){console.error("Could not stringify config data for item:",configId,stringifyError);selectorDiv.dataset.configData=JSON.stringify({error:"Could not store full config"});} const itemDiv=document.createElement('div');itemDiv.className='toolbar-item suds-component-icon';itemDiv.title=`Select ${productCode}`;itemDiv.textContent=initials;const labelSpan=document.createElement('span');labelSpan.className='component-label';labelSpan.textContent=productCode;selectorDiv.appendChild(itemDiv);selectorDiv.appendChild(labelSpan);componentItemsContainer.appendChild(selectorDiv);selectorDiv.addEventListener('click',handleToolbarSelection);}catch(itemError){console.error("Error creating list item for config:",config,itemError);}});}
function initializePlanner(){resizeCanvas();window.addEventListener('resize',resizeCanvas);loadSavedComponents();placeModeButton.addEventListener('click',()=>setMode('place'));moveModeButton.addEventListener('click',()=>setMode('move'));connectModeButton.addEventListener('click',()=>setMode('connect'));scaleModeButton.addEventListener('click',()=>setMode('scale'));deleteModeButton.addEventListener('click',()=>setMode('delete'));clearButton.addEventListener('click',clearAll);imageUploadInput.addEventListener('change',handleImageUpload);toggleOverlayButton.addEventListener('click',toggleImageOverlay);zoomResetButton.addEventListener('click',resetView);lockBgButton.addEventListener('click',toggleBackgroundLock);saveButton.addEventListener('click',savePlan);loadButton.addEventListener('click',loadPlan);exportPngButton.addEventListener('click',exportCanvasAsPng);exportListButton.addEventListener('click',exportListAsCsv);bgOpacitySlider.addEventListener('input',handleBgOpacityChange);canvas.addEventListener('mousedown',handleMouseDown);canvas.addEventListener('mousemove',handleMouseMove);canvas.addEventListener('mouseup',handleMouseUp);canvas.addEventListener('mouseout',handleMouseOut);canvas.addEventListener('wheel',handleWheelZoom,{passive:!1});itemLabelInput.addEventListener('input',handleLabelChange);itemListContainer.addEventListener('dragover',handleDragOver);loadPlan();setMode('place');updateToggleButtonState();updateLockBgButtonState();updateScaleDisplay();updateCursor();bgOpacitySlider.value=bgOpacity;}
function screenToWorld(screenX,screenY){return{x:(screenX-originX)/scale,y:(screenY-originY)/scale};}
function getRawMousePos(event){const rect=canvas.getBoundingClientRect();return{x:event.clientX-rect.left,y:event.clientY-rect.top};}
function resizeCanvas(){canvas.width=canvasContainer.offsetWidth;canvas.height=canvasContainer.offsetHeight;redrawCanvas();}
function drawGrid(){const worldLeft=screenToWorld(0,0).x;const worldTop=screenToWorld(0,0).y;const worldRight=screenToWorld(canvas.width,canvas.height).x;const worldBottom=screenToWorld(canvas.width,canvas.height).y;const startX=Math.ceil(worldLeft/gridSpacing)*gridSpacing;const startY=Math.ceil(worldTop/gridSpacing)*gridSpacing;ctx.beginPath();ctx.strokeStyle=gridColor;ctx.lineWidth=0.5/scale;for(let x=startX;x<worldRight;x+=gridSpacing){ctx.moveTo(x,worldTop);ctx.lineTo(x,worldBottom);} for(let y=startY;y<worldBottom;y+=gridSpacing){ctx.moveTo(worldLeft,y);ctx.lineTo(worldRight,y);} ctx.stroke();}
function drawItems(){const itemDrawColor=getComputedStyle(document.documentElement).getPropertyValue('--primary-blue').trim()||'#1d80b9';const itemTextColor='#ffffff';placedItems.forEach(item=>{const initials=item.configData?.derived_product_name?getInitials(item.configData.derived_product_name):'?';ctx.beginPath();ctx.arc(item.x,item.y,itemRadius/scale,0,Math.PI*2);ctx.fillStyle=itemDrawColor;ctx.shadowColor='rgba(0,0,0,0.2)';ctx.shadowBlur=4/scale;ctx.shadowOffsetY=1/scale;ctx.fill();ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetY=0;const isSelectedForProp=item.id===selectedItemId;const isSelectedForConn=isConnecting&&item.id===connectionStartItemId;const isHovered=item.id===hoveredItemId;if(isSelectedForProp||isSelectedForConn||isHovered){ctx.strokeStyle=isHovered?'orange':selectionHighlightColor;ctx.lineWidth=(isHovered?4:3)/scale;ctx.stroke();} const fontSize=Math.max(8,Math.min(14,10/scale));ctx.fillStyle=itemTextColor;ctx.font=`bold ${fontSize}px Montserrat`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(initials,item.x,item.y);if(item.label){ctx.fillStyle='#333333';ctx.font=`${fontSize*0.9}px Montserrat`;ctx.fillText(item.label,item.x,item.y+(itemRadius*1.5/scale));}}); }
function drawConnections(){if(connections.length===0)return;ctx.beginPath();ctx.lineWidth=connectionWidth/scale;ctx.lineCap='round';connections.forEach(conn=>{const item1=placedItems.find(item=>item.id===conn.item1Id);const item2=placedItems.find(item=>item.id===conn.item2Id);if(item1&&item2){ctx.strokeStyle=(hoveredConnection===conn)?'orange':connectionColor;ctx.moveTo(item1.x,item1.y);ctx.lineTo(item2.x,item2.y);ctx.stroke();}});ctx.lineCap='butt';}
function drawBackgroundImage(){if(isOverlayVisible&&backgroundImage){ctx.globalAlpha=bgOpacity;ctx.drawImage(backgroundImage,bgImageX,bgImageY,backgroundImage.width,backgroundImage.height);ctx.globalAlpha=1.0;}}
function drawRulerLine(){if(!rulerStartPoint||!rulerEndPoint)return;ctx.beginPath();ctx.strokeStyle=rulerColor;ctx.lineWidth=2/scale;ctx.setLineDash([5/scale,5/scale]);ctx.moveTo(rulerStartPoint.x,rulerStartPoint.y);ctx.lineTo(rulerEndPoint.x,rulerEndPoint.y);ctx.stroke();ctx.setLineDash([]);const pixelDist=calculateDistance(rulerStartPoint,rulerEndPoint);const midX=(rulerStartPoint.x+rulerEndPoint.x)/2;const midY=(rulerStartPoint.y+rulerEndPoint.y)/2;ctx.fillStyle=rulerColor;ctx.font=`bold ${12/scale}px Montserrat`;ctx.textAlign='center';ctx.textBaseline='bottom';ctx.shadowColor='rgba(255,255,255,0.7)';ctx.shadowBlur=3/scale;ctx.fillText(`${pixelDist.toFixed(1)} px`,midX,midY-(5/scale));ctx.shadowColor='transparent';ctx.shadowBlur=0;}
function redrawCanvas(forExport=!1){ctx.save();if(forExport){ctx.fillStyle='#ffffff';ctx.fillRect(0,0,canvas.width,canvas.height);}else{ctx.clearRect(0,0,canvas.width,canvas.height);} ctx.translate(originX,originY);ctx.scale(scale,scale);drawBackgroundImage();drawGrid();drawConnections();drawItems();if(isDrawingRuler){drawRulerLine();} drawPipeLengths(); ctx.restore();if(!forExport){updateItemList();}}
function drawPipeLengths(){if(!worldScale||worldScale<=0||connections.length===0)return;ctx.fillStyle='#000000';ctx.textAlign='center';ctx.textBaseline='bottom';const fontSize=Math.max(6,Math.min(10,9/scale));ctx.font=`${fontSize}px Montserrat`;connections.forEach(conn=>{const item1=placedItems.find(i=>i.id===conn.item1Id);const item2=placedItems.find(i=>i.id===conn.item2Id);if(item1&&item2){const pixelDist=calculateDistance(item1,item2);const realLength=pixelDist/worldScale;const lengthText=`${realLength.toFixed(1)} ${worldUnits||'units'}`;const midX=(item1.x+item2.x)/2;const midY=(item1.y+item2.y)/2;ctx.save();ctx.fillText(lengthText,midX,midY-(5/scale));ctx.restore();}});}
function getOrdinalSuffix(i){const j=i%10,k=i%100;if(j==1&&k!=11)return i+"st";if(j==2&&k!=12)return i+"nd";if(j==3&&k!=13)return i+"rd";if(i===1)return"First";if(i===2)return"Second";if(i===3)return"Third";return i+"th";}
function updateItemList(){if(!itemListContainer)return;itemListContainer.innerHTML='';if(placedItems.length===0){itemListContainer.innerHTML='<p style="text-align:center;font-size:0.8em;color:#6c757d;margin-top:10px;">No items placed yet.</p>';return;} const itemIndexMap=new Map(placedItems.map((item,index)=>[item.id,index]));placedItems.forEach((item,index)=>{const initials=item.configData?.derived_product_name?getInitials(item.configData.derived_product_name):'?';const componentName=item.configData?.derived_product_name||'Unknown Item';const productCode=item.configData?.generated_product_code||'';const entryDiv=document.createElement('div');entryDiv.className='placed-item-entry';entryDiv.draggable=!0;entryDiv.dataset.itemId=item.id;entryDiv.dataset.index=index;const iconSpan=document.createElement('span');iconSpan.className='item-list-icon';iconSpan.textContent=initials;entryDiv.appendChild(iconSpan);const detailsSpan=document.createElement('span');detailsSpan.className='item-list-details';const nameSpan=document.createElement('span');nameSpan.className='item-list-name';nameSpan.textContent=componentName;detailsSpan.appendChild(nameSpan);const codeSpan=document.createElement('span');codeSpan.className='item-list-label';codeSpan.textContent=productCode||'(No Code)';detailsSpan.appendChild(codeSpan);const connectionsDiv=document.createElement('div');connectionsDiv.className='item-list-connections';let hasConnections=!1;connections.forEach(conn=>{let otherItemId=-1;if(conn.item1Id===item.id){otherItemId=conn.item2Id;}else if(conn.item2Id===item.id){otherItemId=conn.item1Id;} if(otherItemId!==-1){const otherItem=placedItems.find(p=>p.id===otherItemId);const otherItemIndex=itemIndexMap.get(otherItemId);if(otherItem&&otherItemIndex!==undefined){hasConnections=!0;const pixelDist=calculateDistance(item,otherItem);let lengthText='';const ordinalName=getOrdinalSuffix(otherItemIndex+1);if(worldScale&&worldScale>0){const realLength=pixelDist/worldScale;lengthText=`Conn to ${ordinalName}: ${realLength.toFixed(1)} ${worldUnits||'units'}`;}else{lengthText=`Conn to ${ordinalName}: ${pixelDist.toFixed(0)} px`;} const connP=document.createElement('div');connP.textContent=lengthText;connectionsDiv.appendChild(connP);}}});if(hasConnections){detailsSpan.appendChild(connectionsDiv);} entryDiv.appendChild(detailsSpan);entryDiv.addEventListener('dragstart',handleDragStart);entryDiv.addEventListener('dragend',handleDragEnd);entryDiv.addEventListener('dragenter',handleDragEnter);entryDiv.addEventListener('dragleave',handleDragLeave);entryDiv.addEventListener('drop',handleDrop);entryDiv.addEventListener('click',()=>selectItemForProperties(item.id));itemListContainer.appendChild(entryDiv);});}
function handleDragStart(event){draggedListElement=event.target;event.dataTransfer.setData('text/plain',event.target.dataset.itemId);event.dataTransfer.effectAllowed='move';setTimeout(()=>{event.target.classList.add('dragging');},0);}
function handleDragEnd(event){if(draggedListElement){draggedListElement.classList.remove('dragging');} const dragOverElements=itemListContainer.querySelectorAll('.drag-over');dragOverElements.forEach(el=>el.classList.remove('drag-over'));draggedListElement=null;}
function handleDragOver(event){event.preventDefault();event.dataTransfer.dropEffect='move';}
function handleDragEnter(event){event.preventDefault();const targetElement=event.target.closest('.placed-item-entry');if(targetElement&&targetElement!==draggedListElement){targetElement.classList.add('drag-over');}}
function handleDragLeave(event){const targetElement=event.target.closest('.placed-item-entry');if(targetElement){targetElement.classList.remove('drag-over');} if(!itemListContainer.contains(event.relatedTarget)){const dragOverElements=itemListContainer.querySelectorAll('.drag-over');dragOverElements.forEach(el=>el.classList.remove('drag-over'));}}
function handleDrop(event){event.preventDefault();const targetElement=event.target.closest('.placed-item-entry');const dragOverElements=itemListContainer.querySelectorAll('.drag-over');dragOverElements.forEach(el=>el.classList.remove('drag-over'));if(targetElement&&targetElement!==draggedListElement){const draggedItemId=parseInt(event.dataTransfer.getData('text/plain'),10);const targetItemId=parseInt(targetElement.dataset.itemId,10);const draggedIndex=placedItems.findIndex(item=>item.id===draggedItemId);let targetIndex=placedItems.findIndex(item=>item.id===targetItemId);if(draggedIndex>-1&&targetIndex>-1){const[draggedItem]=placedItems.splice(draggedIndex,1);if(draggedIndex<targetIndex){targetIndex--;} placedItems.splice(targetIndex,0,draggedItem);redrawCanvas();}} if(draggedListElement){draggedListElement.classList.remove('dragging');}}
function handleMouseDown(event){const rawMousePos=getRawMousePos(event);const worldPos=screenToWorld(rawMousePos.x,rawMousePos.y);lastMouseX=rawMousePos.x;lastMouseY=rawMousePos.y;const clickedItem=findItemAt(worldPos.x,worldPos.y);isDraggingItem=isPanning=isDraggingBackground=isDrawingRuler=!1;draggedItemId=null;if(currentMode==='place'||currentMode==='move'){if(clickedItem){selectItemForProperties(clickedItem.id);}else{deselectItemForProperties();}}else{deselectItemForProperties();} if(currentMode==='place'&&selectedSavedConfig&&!clickedItem){placeItem(worldPos.x,worldPos.y);}else if(currentMode==='connect'){handleConnectionClick(worldPos.x,worldPos.y);}else if(currentMode==='move'&&clickedItem){isDraggingItem=!0;draggedItemId=clickedItem.id;dragStartX=worldPos.x;dragStartY=worldPos.y;canvasContainer.classList.add('move-cursor');}else if(currentMode==='delete'&&clickedItem){deleteItem(clickedItem.id);}else if(currentMode==='scale'){isDrawingRuler=!0;rulerStartPoint={x:worldPos.x,y:worldPos.y};rulerEndPoint={x:worldPos.x,y:worldPos.y};redrawCanvas();}else if(currentMode==='move'&&!isBackgroundLocked&&isOverlayVisible&&backgroundImage&&isPointInBackground(worldPos.x,worldPos.y)){isDraggingBackground=!0;canvasContainer.classList.add('move-cursor');}else if(!clickedItem){isPanning=!0;canvasContainer.classList.add('panning');}}
function handleMouseMove(event){const rawMousePos=getRawMousePos(event);const worldPos=screenToWorld(rawMousePos.x,rawMousePos.y);const dx=rawMousePos.x-lastMouseX;const dy=rawMousePos.y-lastMouseY;let needsRedraw=!1;let tooltipContent=null;let tooltipX=rawMousePos.x+15;let tooltipY=rawMousePos.y+10;if(isDraggingItem&&draggedItemId!==null){const item=placedItems.find(i=>i.id===draggedItemId);if(item){if(event.shiftKey){const currentDx=worldPos.x-dragStartX;const currentDy=worldPos.y-dragStartY;const dist=Math.sqrt(currentDx*currentDx+currentDy*currentDy);if(dist>0){const angle=Math.atan2(currentDy,currentDx);const snappedAngle=Math.round(angle/(Math.PI/4))*(Math.PI/4);item.x=dragStartX+dist*Math.cos(snappedAngle);item.y=dragStartY+dist*Math.sin(snappedAngle);}}else{item.x+=dx/scale;item.y+=dy/scale;} needsRedraw=!0;}}else if(isDraggingBackground){bgImageX+=dx/scale;bgImageY+=dy/scale;needsRedraw=!0;}else if(isDrawingRuler){rulerEndPoint={x:worldPos.x,y:worldPos.y};needsRedraw=!0;}else if(isPanning){originX+=dx;originY+=dy;needsRedraw=!0;}else if(!isTouchDevice){let currentHoverItemId=null;let currentHoverConnection=null;const hoveredItem=findItemAt(worldPos.x,worldPos.y);if(hoveredItem){currentHoverItemId=hoveredItem.id;const componentName=hoveredItem.configData?.derived_product_name||'Unknown Item';tooltipContent=`<strong>${componentName} (ID: ${hoveredItem.id})</strong><br>${hoveredItem.label||'(No Label)'}`;}else{currentHoverConnection=findConnectionNear(worldPos.x,worldPos.y);if(currentHoverConnection){const item1=placedItems.find(i=>i.id===currentHoverConnection.item1Id);const item2=placedItems.find(i=>i.id===currentHoverConnection.item2Id);if(item1&&item2){const pixelDist=calculateDistance(item1,item2);if(worldScale&&worldScale>0){const realLength=pixelDist/worldScale;tooltipContent=`Length: ${realLength.toFixed(1)} ${worldUnits||'units'}`;}else{tooltipContent=`Length: ${pixelDist.toFixed(0)} px`;}}}} if(tooltipContent){updateTooltip(tooltipContent,tooltipX,tooltipY);}else{hideTooltip();} if(currentHoverItemId!==hoveredItemId||currentHoverConnection!==hoveredConnection){hoveredItemId=currentHoverItemId;hoveredConnection=currentHoverConnection;needsRedraw=!0;}} lastMouseX=rawMousePos.x;lastMouseY=rawMousePos.y;if(needsRedraw){redrawCanvas();}}
function handleMouseUp(event){if(isDrawingRuler){isDrawingRuler=!1;if(rulerStartPoint&&rulerEndPoint&&calculateDistance(rulerStartPoint,rulerEndPoint)>0.1){setTimeout(()=>setScaleFromRuler(),0);}else{rulerStartPoint=null;rulerEndPoint=null;redrawCanvas();}} isDraggingItem=!1;isPanning=!1;isDraggingBackground=!1;draggedItemId=null;canvasContainer.classList.remove('panning','move-cursor');updateCursor();}
function handleMouseOut(event){if(isDraggingItem||isPanning||isDraggingBackground||isDrawingRuler){isDraggingItem=!1;isPanning=!1;isDraggingBackground=!1;isDrawingRuler=!1;draggedItemId=null;rulerStartPoint=null;rulerEndPoint=null;canvasContainer.classList.remove('panning','move-cursor');updateCursor();redrawCanvas();} hideTooltip();if(hoveredItemId||hoveredConnection){hoveredItemId=null;hoveredConnection=null;redrawCanvas();}}
function handleToolbarSelection(event){const targetItem=event.currentTarget;setMode('place');if(selectedToolbarElement){selectedToolbarElement.classList.remove('selected');} const configDataString=targetItem.dataset.configData;if(configDataString){try{selectedSavedConfig=JSON.parse(configDataString);}catch(e){console.error("Error parsing config data from toolbar item:",e);selectedSavedConfig=null;}}else{selectedSavedConfig=null;} selectedToolbarElement=targetItem;selectedToolbarElement.classList.add('selected');updateCursor();}
function handleImageUpload(event){const file=event.target.files[0];if(file&&file.type.startsWith('image/')){const reader=new FileReader();reader.onload=function(e){const img=new Image();img.onload=function(){backgroundImage=img;bgImageX=0;bgImageY=0;redrawCanvas();};img.onerror=function(){backgroundImage=null;};img.src=e.target.result;};reader.onerror=function(){backgroundImage=null;};reader.readAsDataURL(file);}else if(file){alert("Please select a valid image file.");imageUploadInput.value=null;}}
function toggleImageOverlay(){isOverlayVisible=!isOverlayVisible;updateToggleButtonState();redrawCanvas();}
function updateToggleButtonState(){toggleOverlayButton.classList.toggle('active',isOverlayVisible);toggleOverlayButton.title=isOverlayVisible?"Hide background image":"Show background image";}
function handleLabelChange(event){if(selectedItemId!==null){const item=placedItems.find(i=>i.id===selectedItemId);if(item){item.label=event.target.value;redrawCanvas();}}}
function handleBgOpacityChange(event){bgOpacity=parseFloat(event.target.value);if(isOverlayVisible&&backgroundImage){redrawCanvas();}}
function handleWheelZoom(event){event.preventDefault();const rawMousePos=getRawMousePos(event);const scrollDelta=event.deltaY;const zoomAmount=Math.pow(scrollZoomFactor,-scrollDelta*0.1);zoom(zoomAmount,rawMousePos.x,rawMousePos.y);}
function toggleBackgroundLock(){isBackgroundLocked=!isBackgroundLocked;updateLockBgButtonState();updateCursor();}
function updateLockBgButtonState(){lockBgButton.textContent=isBackgroundLocked?'Unlock BG':'Lock BG';lockBgButton.title=isBackgroundLocked?'Unlock background movement':'Lock background movement';lockBgButton.classList.toggle('active',isBackgroundLocked);}
function placeItem(worldX,worldY){if(!selectedSavedConfig){return;} const newItemId=nextItemId++;placedItems.push({x:worldX,y:worldY,type:selectedSavedConfig.product_type||'unknown',id:newItemId,label:'',configData:selectedSavedConfig});if(selectedToolbarElement){selectedToolbarElement.classList.remove('selected');} selectedSavedConfig=null;selectedToolbarElement=null;updateCursor();redrawCanvas();}
function handleConnectionClick(worldX,worldY){const clickedItem=findItemAt(worldX,worldY);if(clickedItem){if(!isConnecting){isConnecting=!0;connectionStartItemId=clickedItem.id;}else{if(clickedItem.id!==connectionStartItemId){const alreadyExists=connections.some(conn=>(conn.item1Id===connectionStartItemId&&conn.item2Id===clickedItem.id)||(conn.item1Id===clickedItem.id&&conn.item2Id===connectionStartItemId));if(!alreadyExists){connections.push({item1Id:connectionStartItemId,item2Id:clickedItem.id});}} isConnecting=!1;connectionStartItemId=null;}}else{if(isConnecting){isConnecting=!1;connectionStartItemId=null;}} updateCursor();redrawCanvas();}
function deleteItem(itemId){placedItems=placedItems.filter(item=>item.id!==itemId);connections=connections.filter(conn=>conn.item1Id!==itemId&&conn.item2Id!==itemId);if(selectedItemId===itemId){deselectItemForProperties();} redrawCanvas();}
function findItemAt(worldX,worldY){const clickRadius=itemRadius/scale;for(let i=placedItems.length-1;i>=0;i--){const item=placedItems[i];const dx=worldX-item.x;const dy=worldY-item.y;if(dx*dx+dy*dy<=clickRadius*clickRadius){return item;}} return null;}
function isPointInBackground(worldX,worldY){if(!backgroundImage)return!1;return worldX>=bgImageX&&worldX<=bgImageX+backgroundImage.width&&worldY>=bgImageY&&worldY<=bgImageY+backgroundImage.height;}
function setMode(newMode){if(isDraggingItem||isPanning||isDraggingBackground||isDrawingRuler)return;currentMode=newMode;isConnecting=!1;connectionStartItemId=null;isDrawingRuler=!1;rulerStartPoint=null;rulerEndPoint=null;if(selectedToolbarElement&&newMode!=='place'){selectedToolbarElement.classList.remove('selected');selectedSavedConfig=null;selectedToolbarElement=null;} deselectItemForProperties();placeModeButton.classList.toggle('active',newMode==='place');moveModeButton.classList.toggle('active',newMode==='move');connectModeButton.classList.toggle('active',newMode==='connect');scaleModeButton.classList.toggle('active',newMode==='scale');deleteModeButton.classList.toggle('active',newMode==='delete');updateCursor();redrawCanvas();}
function updateCursor(){canvasContainer.classList.remove('panning','move-cursor','crosshair-cursor','pointer-cursor','copy-cursor','locked-cursor','grab-cursor');if(isPanning){canvasContainer.classList.add('panning');return;} if(isDraggingItem||isDraggingBackground){canvasContainer.classList.add('move-cursor');return;} switch(currentMode){case'place':canvasContainer.classList.add(selectedSavedConfig?'copy-cursor':'crosshair-cursor');break;case'move':canvasContainer.classList.add('move-cursor');break;case'connect':canvasContainer.classList.add(isConnecting?'pointer-cursor':'crosshair-cursor');break;case'scale':canvasContainer.classList.add('crosshair-cursor');break;case'delete':canvasContainer.classList.add('pointer-cursor');break;default:canvasContainer.classList.add('grab-cursor');break;} if(!canvasContainer.classList.contains('copy-cursor')&&!canvasContainer.classList.contains('move-cursor')&&!canvasContainer.classList.contains('crosshair-cursor')&&!canvasContainer.classList.contains('pointer-cursor')){canvasContainer.classList.add('grab-cursor');}}
function selectItemForProperties(itemId){if(selectedItemId!==itemId){selectedItemId=itemId;const item=placedItems.find(i=>i.id===itemId);if(item){itemLabelInput.value=item.label||'';propertiesPanel.style.display='block';redrawCanvas();}else{deselectItemForProperties();}}}
function deselectItemForProperties(){if(selectedItemId!==null){selectedItemId=null;propertiesPanel.style.display='none';itemLabelInput.value='';redrawCanvas();}}
function zoom(factor,centerX,centerY){const worldPos=screenToWorld(centerX,centerY);scale=Math.max(minScale,Math.min(maxScale,scale*factor));originX=centerX-worldPos.x*scale;originY=centerY-worldPos.y*scale;redrawCanvas();}
function resetView(){scale=1.0;originX=0;originY=0;bgImageX=0;bgImageY=0;redrawCanvas();}
function calculateDistance(p1,p2){const dx=p2.x-p1.x;const dy=p2.y-p1.y;return Math.sqrt(dx*dx+dy*dy);}
function setScaleFromRuler(){const pixelDist=calculateDistance(rulerStartPoint,rulerEndPoint);if(pixelDist<=0){rulerStartPoint=null;rulerEndPoint=null;redrawCanvas();return;} setTimeout(()=>{const realLengthStr=prompt(`Enter the real-world length this line represents (pixel length: ${pixelDist.toFixed(1)} px):`);if(realLengthStr===null){rulerStartPoint=null;rulerEndPoint=null;redrawCanvas();return;} const realLength=parseFloat(realLengthStr);if(isNaN(realLength)||realLength<=0){alert("Invalid length entered.");rulerStartPoint=null;rulerEndPoint=null;redrawCanvas();return;} const unitsStr=prompt("Enter the units for this length (e.g., m, ft):",worldUnits||'m');if(unitsStr===null){rulerStartPoint=null;rulerEndPoint=null;redrawCanvas();return;} worldScale=pixelDist/realLength;worldUnits=unitsStr.trim()||'units';updateScaleDisplay();rulerStartPoint=null;rulerEndPoint=null;redrawCanvas();},10);}
function updateScaleDisplay(){if(worldScale&&worldScale>0){const pixelsPerUnit=worldScale;scaleDisplayElement.textContent=`Scale: 1 ${worldUnits||'unit'} ≈ ${pixelsPerUnit.toFixed(1)} px`;scaleDisplayElement.title=`Current scale is ${worldScale.toFixed(4)} pixels per ${worldUnits||'unit'}`;}else{scaleDisplayElement.textContent="Scale not set";scaleDisplayElement.title="Use Scale mode to set scale";}}
function findConnectionNear(worldX,worldY){let closestConn=null;let minDistSq=Infinity;const threshold=hoverThreshold/scale;for(const conn of connections){const item1=placedItems.find(i=>i.id===conn.item1Id);const item2=placedItems.find(i=>i.id===conn.item2Id);if(!item1||!item2)continue;const distSq=pointLineSegmentDistanceSq(worldX,worldY,item1.x,item1.y,item2.x,item2.y);if(distSq<threshold*threshold&&distSq<minDistSq){minDistSq=distSq;closestConn=conn;}} return closestConn;}
function pointLineSegmentDistanceSq(px,py,x1,y1,x2,y2){const l2=(x2-x1)*(x2-x1)+(y2-y1)*(y2-y1);if(l2===0)return(px-x1)*(px-x1)+(py-y1)*(py-y1);let t=((px-x1)*(x2-x1)+(py-y1)*(y2-y1))/l2;t=Math.max(0,Math.min(1,t));const projX=x1+t*(x2-x1);const projY=y1+t*(y2-y1);const dx=px-projX;const dy=py-projY;return dx*dx+dy*dy;}
function updateTooltip(text,screenX,screenY){if(!canvasTooltip)return;canvasTooltip.innerHTML=text;canvasTooltip.style.display='block';const containerRect=canvasContainer.getBoundingClientRect();let left=screenX+15;let top=screenY+10;if(left+canvasTooltip.offsetWidth>containerRect.width){left=screenX-canvasTooltip.offsetWidth-10;} if(top+canvasTooltip.offsetHeight>containerRect.height){top=screenY-canvasTooltip.offsetHeight-5;} if(left<0)left=5;if(top<0)top=5;canvasTooltip.style.left=`${left}px`;canvasTooltip.style.top=`${top}px`;}
function hideTooltip(){if(canvasTooltip){canvasTooltip.style.display='none';}}
function savePlan(){try{const planData={items:placedItems,connections:connections,nextId:nextItemId,bgPos:{x:bgImageX,y:bgImageY},bgLocked:isBackgroundLocked,worldScale:worldScale,worldUnits:worldUnits};localStorage.setItem(plannerDataStorageKey,JSON.stringify(planData));alert("Plan saved successfully!");}catch(error){console.error("Error saving plan:",error);alert("Error saving plan.");}}
function loadPlan(){try{const jsonData=localStorage.getItem(plannerDataStorageKey);if(jsonData){const planData=JSON.parse(jsonData);if(planData&&Array.isArray(planData.items)&&Array.isArray(planData.connections)){placedItems=planData.items;connections=planData.connections;placedItems.forEach(item=>{if(item.label===undefined)item.label='';});nextItemId=planData.nextId||calculateNextId();if(planData.bgPos){bgImageX=planData.bgPos.x??0;bgImageY=planData.bgPos.y??0;}else{bgImageX=0;bgImageY=0;} isBackgroundLocked=planData.bgLocked??!0;updateLockBgButtonState();worldScale=planData.worldScale??null;worldUnits=planData.worldUnits??'';updateScaleDisplay();bgOpacity=1.0;bgOpacitySlider.value=bgOpacity;resetView();}else{localStorage.removeItem(plannerDataStorageKey);initializeEmptyPlanState();redrawCanvas();}}else{initializeEmptyPlanState();redrawCanvas();}}catch(error){console.error("Error loading plan:",error);alert("Error loading plan.");localStorage.removeItem(plannerDataStorageKey);initializeEmptyPlanState();redrawCanvas();}}
function initializeEmptyPlanState(){placedItems=[];connections=[];nextItemId=0;bgImageX=0;bgImageY=0;isBackgroundLocked=!0;updateLockBgButtonState();scale=1.0;originX=0;originY=0;bgOpacity=1.0;bgOpacitySlider.value=bgOpacity;worldScale=null;worldUnits='';updateScaleDisplay();}
function calculateNextId(){return placedItems.reduce((maxId,item)=>Math.max(maxId,item.id),-1)+1;}
function exportCanvasAsPng(){if(canvas.width===0||canvas.height===0){alert("Cannot export empty canvas.");return;} try{redrawCanvas(!0);let dataUrl='';try{dataUrl=canvas.toDataURL('image/png');}catch(e){console.error("Error getting data URL:",e);alert(`Could not get image data. Error: ${e.message}`);return;} const link=document.createElement('a');link.href=dataUrl;link.download='drainage-plan.png';document.body.appendChild(link);link.click();document.body.removeChild(link);}catch(error){console.error("Error exporting canvas:",error);alert(`Could not export canvas. Error: ${error.message}`);}}
function exportListAsCsv(){if(connections.length===0){alert("No connections to export.");return;} const header="Item1_ID,Item1_Name,Item1_Label,Item2_ID,Item2_Name,Item2_Label,Length,Units\n"; const escapeCsv=(str)=>{if(str===null||str===undefined)return'';const string=String(str);if(string.includes('"')||string.includes(',')||string.includes('\n')){return`"${string.replace(/"/g,'""')}"`;} return string;}; const rows=connections.map(conn=>{const item1=placedItems.find(i=>i.id===conn.item1Id);const item2=placedItems.find(i=>i.id===conn.item2Id);if(!item1||!item2)return null; const name1=item1.configData?.derived_product_name || 'Unknown';const name2=item2.configData?.derived_product_name || 'Unknown';const pixelDist=calculateDistance(item1,item2);let lengthStr='';let unitStr='';if(worldScale&&worldScale>0){lengthStr=(pixelDist/worldScale).toFixed(2);unitStr=worldUnits||'units';}else{lengthStr=pixelDist.toFixed(0);unitStr='px';} return[item1.id,escapeCsv(name1),escapeCsv(item1.label),item2.id,escapeCsv(name2),escapeCsv(item2.label),lengthStr,unitStr].join(',');}).filter(row=>row!==null).join('\n'); const csvString=header+rows; try{const blob=new Blob([csvString],{type:'text/csv;charset=utf-8;'});const link=document.createElement('a');const url=URL.createObjectURL(blob);link.setAttribute('href',url);link.setAttribute('download','planner-connections.csv');link.style.visibility='hidden';document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);}catch(error){console.error("Error exporting list as CSV:",error);alert("Could not export list.");}}
function clearAll(){if(confirm("Are you sure you want to clear the entire plan? This includes the background image and scale setting, and cannot be undone.")){isConnecting=!1;connectionStartItemId=null;backgroundImage=null;isOverlayVisible=!1;imageUploadInput.value=null;deselectItemForProperties();updateToggleButtonState();initializeEmptyPlanState();if(selectedToolbarElement){selectedToolbarElement.classList.remove('selected');selectedSavedConfig=null;selectedToolbarElement=null;} setMode('place');}}
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',initializePlanner);}else{initializePlanner();}
});
</script>
</body>
</html>